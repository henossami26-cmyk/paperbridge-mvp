<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PaperBridge â€” MVP</title>
  <style>
    /* Theme variables live here; press Shift+O to open the owner panel and restyle on the fly. */
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --accent:#0f62fe;
      --border:#d7d7e6;
      --pill-bg:#eef2ff;
      --pill-border:#c7d2fe;
    }
    body{font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--text);}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 3px color-mix(in srgb, var(--text) 10%, transparent)}
    .in{padding:16px}
    textarea{width:100%;height:230px;border:1px solid var(--border);border-radius:10px;padding:12px;resize:vertical;background:var(--card);color:var(--text)}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{border:1px solid var(--border);border-radius:10px;background:var(--accent);color:var(--card);padding:8px 12px;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px color-mix(in srgb, var(--accent) 25%, transparent)}
    button.secondary{background:var(--card);color:var(--text)}
    .out{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;min-height:120px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--pill-bg);color:var(--text);font-size:12px;border:1px solid var(--pill-border);margin-right:6px}
    .list li{padding:8px 0;border-top:1px solid var(--border)}
    small{color:var(--text);opacity:.7}
    .owner-panel{position:fixed;bottom:24px;right:24px;width:280px;max-width:calc(100% - 32px);background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 40px color-mix(in srgb, var(--text) 35%, transparent);padding:16px;transform:translateY(calc(100% + 32px));transition:transform .25s ease,opacity .2s ease;opacity:0;pointer-events:none;z-index:20}
    .owner-panel.owner-panel--open{transform:translateY(0);opacity:1;pointer-events:auto}
    .owner-panel h2{margin:0 0 12px;font-size:18px;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .owner-panel .mode-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:999px;background:var(--pill-bg);border:1px solid var(--pill-border);font-size:11px;text-transform:uppercase;letter-spacing:.04em}
    .owner-panel-fields{display:grid;gap:6px;margin-bottom:8px}
    .owner-panel label{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin:0}
    .owner-panel input[type=color]{width:48px;height:28px;border:none;padding:0;background:none;cursor:pointer}
    .owner-panel .panel-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px}
    .owner-panel .panel-buttons button{font-size:12px;padding:8px 10px}
    .owner-panel .panel-buttons button.secondary{color:var(--text)}
    .owner-panel .foot-buttons{display:flex;gap:8px;margin-top:12px}
    .owner-panel .foot-buttons button{flex:1;font-size:12px;padding:8px 10px}
    .owner-panel .close-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-size:12px}
    .owner-panel .close-row button{font-size:12px;padding:6px 10px}
    .owner-panel small{display:block;margin-top:6px;font-size:11px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ðŸŒ‰ PaperBridge â€” Understand Every Form</h1>
  <p><small>Client-only demo. No data leaves your browser.</small></p>

  <div class="grid">
    <div class="card">
      <div class="in">
        <label><strong>Paste form text</strong></label>
        <textarea id="input">By signing this form, the applicant hereby consents to disclose their SIN pursuant to the program assessment. Notwithstanding any other provision herein, failure to remit sufficient documentation may render the application void.</textarea>
        <div class="row">
          <button id="btnSimple">Simplify</button>
          <button id="btnLine" class="secondary">Line-by-line</button>
          <button id="btnCopy" class="secondary">Copy simplified</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="in">
        <div class="row">
          <span class="pill" id="modePill">Mode: Simple</span>
          <span class="pill" id="termPill">Terms: 0</span>
        </div>
        <div id="output" class="out"></div>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:16px">
    <div class="card">
      <div class="in">
        <div><strong>Glossary</strong></div>
        <ul id="gloss" class="list"></ul>
      </div>
    </div>
    <div class="card">
      <div class="in">
        <div><strong>Tips</strong></div>
        <ol>
          <li>Use <strong>Line-by-line</strong> to see each sentence with its simpler version.</li>
          <li>Weâ€™ll add a private <strong>Profile Vault</strong> next (name, DOB, address, passport, SIN).</li>
          <li>Then weâ€™ll <strong>auto-fill PDFs</strong> in-browser using your profile.</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<script>
// 1) Legal/bureaucratic jargon (shows up in Glossary)
const JARGON_MAP = {
  hereby:{simple:"by this",note:"Formal for 'by this document/action'."},
  thereon:{simple:"on that",note:"Refers to something mentioned earlier."},
  thereof:{simple:"of that",note:"Refers back to earlier thing."},
  therein:{simple:"in that",note:"In that document/place."},
  herein:{simple:"in this",note:"In this document."},
  notwithstanding:{simple:"despite",note:"Prefer 'despite'."},
  pursuant:{simple:"according to",note:"In line with / according to."},
  commence:{simple:"start",note:"Plain verb."},
  terminate:{simple:"end",note:"Plain verb."},
  remit:{simple:"send",note:"Often a payment/documents."},
  sufficient:{simple:"enough",note:"Plain word."},
  utilize:{simple:"use",note:"Prefer 'use'."},
  applicant:{simple:"person applying",note:"The person filling the form."},
  disclose:{simple:"share",note:"Share information."},
  verify:{simple:"confirm",note:"Make sure it's true."},
  void:{simple:"not valid",note:"Won't be accepted."},
  assessment:{simple:"review/decision",note:"Government's review."},
  domicile:{simple:"permanent home",note:"Main legal home."},
  affidavit:{simple:"sworn statement",note:"Statement promised as true."},
  spouse:{simple:"husband or wife",note:"Married partner."},
  "common-law":{simple:"live-in partner (12+ months)",note:"Lived together 12+ months."},
  sin:{simple:"Social Insurance Number",note:"9-digit number in Canada."}
};

// 2) General plain-English rewrites (works on everyday text)
const PHRASES = [
  [/in accordance with/gi, "according to"],
  [/in the event that/gi, "if"],
  [/in order to/gi, "to"],
  [/prior to/gi, "before"],
  [/subsequent to/gi, "after"],
  [/with respect to/gi, "about"],
  [/with regard to/gi, "about"],
  [/for the purpose of/gi, "to"],
  [/has shifted to/gi, "now uses"],
  [/is required to/gi, "must"],
  [/is not required to/gi, "does not have to"],
  [/including but not limited to/gi, "including"],
  [/such as/gi, "like"],
  [/specific forms needed depend on/gi, "forms depend on"],
  [/in order for/gi, "for"],
  [/alternative formats upon request/gi, "other formats if you ask"]
];

// Split sentences safely
const splitSentences = (t) => t.trim().replace(/\s+/g,' ').split(/(?<=[.!?])\s+/);

// Apply legalese replacements + collect glossary hits
function replaceJargon(text){
  const hits = {};
  const out = text.replace(/\b[\w-]+\b/gi, (tok) => {
    const key = tok.replace(/[^\w-]/g,"").toLowerCase();
    const entry = JARGON_MAP[key];
    if(!entry) return tok;
    hits[key] ??= { ...entry, count:0 };
    hits[key].count++;
    const isCap = /^[A-Z]/.test(tok);
    const simple = entry.simple;
    return isCap ? simple.charAt(0).toUpperCase()+simple.slice(1) : simple;
  });
  return { text: out, hits };
}

// Apply general simplifications
function simplifyPhrases(text){
  let t = text;
  for(const [re, rep] of PHRASES) t = t.replace(re, rep);
  return t;
}

function simplifyAll(text){
  let t = simplifyPhrases(text);
  const { text: withJargon, hits } = replaceJargon(t);
  const sentences = splitSentences(text);
  const simplifiedSentences = splitSentences(withJargon).map(s => s.trim());
  return {
    sentences,
    simplifiedSentences,
    simplified: simplifiedSentences.join(" "),
    glossary: Object.entries(hits).map(([term,v])=>({term, ...v}))
  };
}

// Wire up UI
const inputEl  = document.getElementById('input');
const outputEl = document.getElementById('output');
const glossEl  = document.getElementById('gloss');
const termPill = document.getElementById('termPill');
const modePill = document.getElementById('modePill');

function render(mode='simple'){
  const r = simplifyAll(inputEl.value);
  modePill.textContent = `Mode: ${mode==='simple'?'Simple':'Line-by-line'}`;
  termPill.textContent = `Terms: ${r.glossary.length}`;

  if(mode==='simple'){
    outputEl.innerHTML = r.simplified;
  } else {
    outputEl.innerHTML = r.sentences.map((orig, i)=>`
      <div style="margin-bottom:12px">
        <div><small>Original</small><br>${orig}</div>
        <div style="margin-top:6px"><small>Simplified</small><br><strong>${r.simplifiedSentences[i]||''}</strong></div>
      </div>`).join('');
  }

  glossEl.innerHTML = r.glossary.length
    ? r.glossary.map(g=>`<li><strong>${g.term}</strong><br>${g.simple}<br><small>${g.note}</small></li>`).join('')
    : '<li><small>No special terms detected.</small></li>';
}

document.getElementById('btnSimple').onclick = () => render('simple');
document.getElementById('btnLine').onclick   = () => render('line');
document.getElementById('btnCopy').onclick   = async () => {
  const r = simplifyAll(inputEl.value);
  try { await navigator.clipboard.writeText(r.simplified); alert('Copied!'); }
  catch { alert('Could not copy.'); }
};

render('simple');
</script>

<div id="ownerPanel" class="owner-panel" aria-hidden="true">
  <div class="close-row">
    <span>Owner Controls</span>
    <button type="button" id="ownerPanelClose" class="secondary">Close</button>
  </div>
  <h2>Theme <span class="mode-pill" id="ownerModePill">LIGHT</span></h2>
  <div class="owner-panel-fields">
    <label>Accent <input type="color" data-var="--accent"></label>
    <label>Background <input type="color" data-var="--bg"></label>
    <label>Card <input type="color" data-var="--card"></label>
    <label>Text <input type="color" data-var="--text"></label>
    <label>Border <input type="color" data-var="--border"></label>
    <label>Pill BG <input type="color" data-var="--pill-bg"></label>
    <label>Pill Border <input type="color" data-var="--pill-border"></label>
  </div>
  <div class="panel-buttons">
    <button type="button" id="ownerReset" class="secondary">Reset</button>
    <button type="button" id="ownerDarkToggle">Toggle Dark Mode</button>
  </div>
  <div class="foot-buttons">
    <button type="button" id="ownerCopy" class="secondary">Copy JSON</button>
    <button type="button" id="ownerPaste">Paste JSON</button>
  </div>
  <div class="foot-buttons">
    <button type="button" id="ownerExport" class="secondary">Theme Export</button>
  </div>
  <small>Changes save automatically. Shift+O toggles this panel.</small>
</div>

<script>
// Owner theme panel logic: Shift+O toggles the panel, updates CSS variables, and syncs with localStorage.
(() => {
  const STORAGE_KEY = 'paperbridge:theme';
  const DEFAULT_THEME = {
    mode:'light',
    vars:{
      '--bg':'#f7f7fb',
      '--card':'#ffffff',
      '--text':'#0f172a',
      '--accent':'#0f62fe',
      '--border':'#d7d7e6',
      '--pill-bg':'#eef2ff',
      '--pill-border':'#c7d2fe'
    }
  };
  const DARK_THEME = {
    mode:'dark',
    vars:{
      '--bg':'#0b1020',
      '--card':'#111427',
      '--text':'#e5e7eb',
      '--accent':'#4f46e5',
      '--border':'#222745',
      '--pill-bg':'#1f2440',
      '--pill-border':'#2b3158'
    }
  };

  const panel = document.getElementById('ownerPanel');
  const closeButton = document.getElementById('ownerPanelClose');
  const modePill = document.getElementById('ownerModePill');
  const colorInputs = Array.from(panel.querySelectorAll('input[type="color"]'));
  const resetButton = document.getElementById('ownerReset');
  const toggleDarkButton = document.getElementById('ownerDarkToggle');
  const copyButton = document.getElementById('ownerCopy');
  const pasteButton = document.getElementById('ownerPaste');
  const exportButton = document.getElementById('ownerExport');

  let isOpen = false;
  let currentTheme = loadTheme();

  applyTheme(currentTheme);
  syncInputs();
  updateModePill();

  function loadTheme(){
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if(!stored) return { ...DEFAULT_THEME, vars:{...DEFAULT_THEME.vars} };
      const parsed = JSON.parse(stored);
      if(!isValidTheme(parsed)) throw new Error('Invalid theme structure');
      return {
        mode:parsed.mode || 'light',
        vars:{ ...DEFAULT_THEME.vars, ...parsed.vars }
      };
    } catch {
      return { ...DEFAULT_THEME, vars:{...DEFAULT_THEME.vars} };
    }
  }

  function saveTheme(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentTheme));
  }

  function applyTheme(theme){
    Object.entries(theme.vars).forEach(([key,value]) => {
      document.documentElement.style.setProperty(key, value);
    });
    document.documentElement.dataset.themeMode = theme.mode;
  }

  function syncInputs(){
    for(const input of colorInputs){
      const key = input.dataset.var;
      if(key && currentTheme.vars[key]){
        input.value = currentTheme.vars[key];
      }
    }
  }

  function updateModePill(){
    const label = (currentTheme.mode || 'light').toUpperCase();
    modePill.textContent = label;
  }

  function setPanelState(open){
    isOpen = open;
    panel.classList.toggle('owner-panel--open', open);
    panel.setAttribute('aria-hidden', String(!open));
  }

  function setTheme(theme){
    currentTheme = {
      mode:theme.mode,
      vars:{ ...DEFAULT_THEME.vars, ...theme.vars }
    };
    applyTheme(currentTheme);
    syncInputs();
    updateModePill();
    saveTheme();
  }

  function isValidTheme(candidate){
    const required = Object.keys(DEFAULT_THEME.vars);
    if(!candidate || typeof candidate !== 'object') return false;
    if(!candidate.vars || typeof candidate.vars !== 'object') return false;
    if(typeof candidate.mode !== 'string') return false;
    return required.every(key => typeof candidate.vars[key] === 'string' && /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(candidate.vars[key]));
  }

  document.addEventListener('keydown', (event) => {
    if(event.key.toLowerCase() === 'o' && event.shiftKey && !event.altKey && !event.ctrlKey && !event.metaKey){
      event.preventDefault();
      setPanelState(!isOpen);
    }
    if(event.key === 'Escape' && isOpen){
      setPanelState(false);
    }
  });

  closeButton.addEventListener('click', () => setPanelState(false));

  colorInputs.forEach((input) => {
    input.addEventListener('input', () => {
      const key = input.dataset.var;
      if(!key) return;
      currentTheme.vars[key] = input.value;
      applyTheme(currentTheme);
      saveTheme();
    });
  });

  resetButton.addEventListener('click', () => {
    localStorage.removeItem(STORAGE_KEY);
    setTheme({ mode: DEFAULT_THEME.mode, vars:{ ...DEFAULT_THEME.vars } });
  });

  toggleDarkButton.addEventListener('click', () => {
    const next = currentTheme.mode === 'dark'
      ? { mode: DEFAULT_THEME.mode, vars:{ ...DEFAULT_THEME.vars } }
      : { mode: DARK_THEME.mode, vars:{ ...DARK_THEME.vars } };
    setTheme(next);
  });

  copyButton.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(JSON.stringify(currentTheme, null, 2));
      alert('Theme JSON copied to clipboard.');
    } catch {
      alert('Copy failed.');
    }
  });

  pasteButton.addEventListener('click', () => {
    const raw = prompt('Paste theme JSON');
    if(!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if(!isValidTheme(parsed)) throw new Error('Invalid');
      setTheme(parsed);
    } catch {
      alert('Invalid theme JSON.');
    }
  });

  exportButton.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(currentTheme, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'paperbridge-theme.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });
})();
</script>
</body>
</html>
