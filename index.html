<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PaperBridge ‚Äî Understand Every Form</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- LZ-String (for share link compression and compressed glossary) -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <!-- Mammoth for docx -> text -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <!-- PDF.js for PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --accent:#0f62fe;
      --border:#d7d7e6;
      --pill-bg:#eef2ff;
      --pill-border:#c7d2fe;
      --muted: rgba(15,23,42,0.6);
      --radius:14px;
      --shadow: 0 12px 30px rgba(2,6,23,0.08);
      --focus: rgba(79,70,229,0.18);
    }
    :root[data-theme="dark"]{
      --bg:#0f1224;
      --card:#111427;
      --text:#e3e6ef;
      --accent:#4f46e5;
      --border:#222745;
      --pill-bg:#1f2440;
      --pill-border:#2b3158;
      --muted: rgba(227,230,239,0.68);
      --shadow: 0 18px 40px rgba(2,6,23,0.45);
      --focus: rgba(79,70,229,0.22);
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;box-sizing:border-box;transition:background .35s ease,color .35s ease;}
    .wrap{max-width:1100px;margin:20px auto;padding:0 18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{margin:0;font-size:26px}
    .lead{margin:0;color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns:1fr;gap:18px;margin-top:18px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .pad{padding:18px}

    label strong{display:block;margin-bottom:8px}
    textarea, input[type="text"]{width:100%;border:1px solid var(--border);border-radius:10px;padding:12px;background:color-mix(in srgb, var(--card) 98%, transparent);color:var(--text);resize:vertical;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco,"Roboto Mono","Courier New",monospace;min-height:220px;box-sizing:border-box}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    button{border:none;border-radius:10px;background:var(--accent);color:var(--card);padding:8px 14px;cursor:pointer;transition:transform .18s ease,box-shadow .18s ease,background .18s;}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.ghost{background:transparent;color:var(--muted);border-radius:8px;padding:6px 10px;border:1px solid transparent}
    button:focus{outline:3px solid var(--focus);outline-offset:3px}

    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--pill-bg);color:var(--text);font-size:13px;border:1px solid var(--pill-border);margin-right:8px}
    .out{background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--border);min-height:120px;box-sizing:border-box}
    .result-box{min-height:120px;padding:12px;border-radius:10px;border:1px solid var(--border);background:color-mix(in srgb,var(--card) 98%, transparent);overflow:auto}
    mark.repl{background: color-mix(in srgb, var(--accent) 18%, transparent); padding:0 6px;border-radius:6px;cursor:pointer;color:inherit}

    .fade-in{animation:fadeIn .36s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    .muted{color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}

    /* Theme control */
    .gear{position:fixed;right:20px;bottom:20px;z-index:100;width:56px;height:56px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer}
    .panel{position:fixed;right:20px;bottom:92px;z-index:110;width:380px;max-width:calc(100% - 32px);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:var(--shadow);transform-origin:100% 100%;transition:transform .18s ease,opacity .16s ease}
    .panel.hidden{opacity:0;transform:translateY(6px) scale(.98);pointer-events:none}
    .panel .row{margin-top:8px}
    .panel input[type="color"]{width:48px;height:32px;border:none;padding:0;background:none;cursor:pointer}

    /* popover */
    .popover{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;max-width:680px;width:92%;background:var(--card);border:1px solid var(--border);padding:16px;border-radius:10px;box-shadow:var(--shadow)}
    .popover .close{position:absolute;right:8px;top:8px;border:none;background:transparent;color:var(--muted);cursor:pointer}

    /* file input visually */
    .fileRow{display:flex;gap:8px;align-items:center;margin-top:10px}
    .fileRow input[type="file"]{border:1px dashed var(--border);padding:8px;border-radius:8px;background:transparent;color:var(--muted)}

    /* ai button */
    .ai-btn{background:linear-gradient(90deg,#06b6d4,#7c3aed);}

    /* mobile tweaks */
    @media(max-width:480px){.pad{padding:12px}textarea{min-height:160px}}
  </style>
</head>
<body>
  <div class="wrap" id="appRoot">
    <header>
      <div>
        <h1>üåâ PaperBridge ‚Äî Understand Every Form</h1>
        <p class="lead">Client-only demo ‚Äî everything runs in your browser. Upload documents, choose reading-level presets, and simplify securely on-device.</p>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="pill" id="statusPill">Ready</div>
        <button id="openTheme" aria-label="Open theme controls" class="secondary">Theme</button>
      </div>
    </header>

    <main class="grid" role="main">
      <!-- Left: input & controls -->
      <section class="card">
        <div class="pad">
          <label><strong>Paste or upload form text</strong></label>
          <textarea id="input" aria-label="Paste form text">By signing this form, the applicant hereby consents to disclose their SIN pursuant to the program assessment. Notwithstanding any other provision herein, failure to remit sufficient documentation may render the application void.</textarea>

          <div class="fileRow">
            <input id="fileInput" type="file" accept=".txt,.md,.json,.docx,.pdf" aria-label="Upload text file (.txt, .md, .json, .docx, .pdf)">
            <div class="muted">Upload .txt/.md/.docx/.pdf. JSON merges to glossary if formatted as term‚Üí{simple,note}.</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <input id="glossaryUpload" type="file" accept=".json" aria-label="Upload glossary JSON" />
            <button id="btnMergeGlossary" class="ghost">Merge glossary</button>
            <div class="muted" style="font-size:13px">Upload a glossary JSON (term ‚Üí {simple,note}) to expand definitions.</div>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:12px;">
            <div style="display:flex;gap:8px;align-items:center">
              <button id="btnSimplify">Simplify</button>
              <button id="btnLine" class="secondary">Line-by-line</button>
              <button id="btnCopy" class="ghost">Copy simplified</button>
              <button id="btnAI" class="ai-btn" title="AI-assisted rewrite">AI Rewrite</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <span class="pill" id="modePill">Mode: Simple</span>
              <span class="pill" id="termPill">Terms: 0</span>
            </div>
          </div>

          <div class="row" style="margin-top:12px;align-items:center">
            <label class="muted" style="margin-right:6px">Preset</label>
            <select id="presetSelect" aria-label="Simplify preset">
              <option value="eli5">Explain like I'm 5 (ELI5)</option>
              <option value="5">5 year old</option>
              <option value="10">10 year old</option>
              <option value="teen">Teenager</option>
              <option value="adult">Adult (Plain)</option>
              <option value="legal">Legal (Keep meaning)</option>
            </select>

            <label class="muted" style="margin-left:12px">Difficulty</label>
            <input id="difficulty" type="range" min="1" max="3" step="1" value="1" aria-label="Difficulty slider" />
            <div id="diffLabel" class="muted" style="min-width:80px;text-align:right">Simple</div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btnTxt" class="ghost">Download .txt</button>
            <button id="btnPdf" class="ghost">Download .pdf</button>
            <button id="btnShare" class="ghost">Copy share link</button>
            <button id="btnClear" class="ghost" style="color:var(--muted)">Clear</button>
          </div>

          <div style="margin-top:12px" class="muted">Tip: For best results upload plain text or .docx. Large glossaries can be uploaded to expand term definitions.</div>
        </div>
      </section>

      <!-- Right: output & glossary -->
      <section class="card" aria-labelledby="outputHeading">
        <div class="pad">
          <div class="out">
            <div id="output" class="result-box" role="region" aria-live="polite" tabindex="0"></div>
          </div>

          <h3 id="outputHeading" style="margin-top:14px">Glossary</h3>
          <ul id="glossary" class="list" aria-live="polite">
            <li><small class="muted">No special terms detected.</small></li>
          </ul>
        </div>
      </section>
    </main>

    <footer>Accessibility: focus visible ‚Ä¢ Contrast tuned ‚Ä¢ Runs fully offline once loaded</footer>
  </div>

  <!-- gear + theme panel -->
  <div class="gear" id="gear" title="Open theme panel">‚öôÔ∏è</div>

  <div class="panel hidden" id="themePanel" role="dialog" aria-modal="true" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Theme & Integrations</strong>
      <button id="themeClose" class="ghost">Close</button>
    </div>

    <div style="margin-top:10px;font-size:13px;color:var(--muted)">Customize colors, add external glossary URL, or configure AI endpoint for rewrites.</div>

    <div class="row" style="margin-top:12px">
      <label style="flex:1;display:flex;justify-content:space-between;align-items:center">Accent <input type="color" data-var="--accent" id="cAccent" aria-label="Accent color"></label>
    </div>
    <div class="row">
      <label style="flex:1;display:flex;justify-content:space-between;align-items:center">Background <input type="color" data-var="--bg" id="cBg" aria-label="Background color"></label>
    </div>
    <div class="row">
      <label style="flex:1;display:flex;justify-content:space-between;align-items:center">Card <input type="color" data-var="--card" id="cCard" aria-label="Card color"></label>
    </div>
    <div class="row">
      <label style="flex:1;display:flex;justify-content:space-between;align-items:center">Text <input type="color" data-var="--text" id="cText" aria-label="Text color"></label>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="themeReset" class="secondary">Reset</button>
      <button id="themeDark" class="">Dark</button>
    </div>

    <div style="margin-top:10px">
      <label style="display:block;font-size:13px;margin-top:10px">External compressed glossary URL (optional)</label>
      <input id="externalGlossaryUrl" type="text" placeholder="/data/glossary.lz (LZ-String compressed JSON)" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="loadExternalGlossary" class="ghost">Load glossary</button>
        <button id="clearExternalGlossary" class="ghost">Clear URL</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <label style="display:block;font-size:13px;margin-top:10px">AI endpoint URL (optional)</label>
      <input id="aiEndpoint" type="text" placeholder="https://your-proxy.example.com/rewrite" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px" />
      <small class="muted">Provide a proxy endpoint that accepts POST { text, preset, difficulty } and returns { rewritten: "..." }.</small>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveAiEndpoint" class="ghost">Save</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="themeCopy" class="ghost">Copy JSON</button>
      <button id="themePaste" class="ghost">Paste JSON / Glossary</button>
      <button id="themeExport" class="ghost">Export</button>
    </div>

    <small class="muted" style="display:block;margin-top:8px">Changes saved to localStorage. Use compressed glossary files with LZ-String for faster loads.</small>
  </div>

  <!-- popover template -->
  <template id="popoverTpl">
    <div class="popover" role="dialog" aria-modal="true">
      <button class="close" aria-label="Close">‚úï</button>
      <div class="title" style="font-weight:700"></div>
      <div class="body" style="margin-top:8px;white-space:pre-wrap"></div>
    </div>
  </template>

  <script>
  /**********************************************************************
   * PaperBridge ‚Äî Full updated single-file app
   * - Lazy external compressed glossary (LZ-String), with worker indexing
   * - File upload: .txt, .md, .docx (via Mammoth), .pdf (via PDF.js)
   * - Preset reading-level simplification (ELI5 / age-targeted)
   * - Difficulty slider + pattern-based simplifier
   * - AI integration stub (client calls user-configured proxy)
   * - Safe DOM rendering (no innerHTML for user text)
   * - Drag/drop and glossary merge + theme customization
   **********************************************************************/

  (function(){
    // Elements
    const inputEl = document.getElementById('input');
    const fileInput = document.getElementById('fileInput');
    const glossaryUpload = document.getElementById('glossaryUpload');
    const outputEl = document.getElementById('output');
    const glossaryEl = document.getElementById('glossary');
    const btnSimplify = document.getElementById('btnSimplify');
    const btnLine = document.getElementById('btnLine');
    const btnCopy = document.getElementById('btnCopy');
    const btnTxt = document.getElementById('btnTxt');
    const btnPdf = document.getElementById('btnPdf');
    const btnShare = document.getElementById('btnShare');
    const btnClear = document.getElementById('btnClear');
    const btnAI = document.getElementById('btnAI');
    const difficulty = document.getElementById('difficulty');
    const diffLabel = document.getElementById('diffLabel');
    const modePill = document.getElementById('modePill');
    const termPill = document.getElementById('termPill');
    const statusPill = document.getElementById('statusPill');
    const presetSelect = document.getElementById('presetSelect');

    const gear = document.getElementById('gear');
    const themePanel = document.getElementById('themePanel');
    const themeClose = document.getElementById('themeClose');
    const themeReset = document.getElementById('themeReset');
    const themeDark = document.getElementById('themeDark');
    const themeCopy = document.getElementById('themeCopy');
    const themePaste = document.getElementById('themePaste');
    const themeExport = document.getElementById('themeExport');
    const externalGlossaryUrlInput = document.getElementById('externalGlossaryUrl');
    const loadExternalGlossary = document.getElementById('loadExternalGlossary');
    const clearExternalGlossary = document.getElementById('clearExternalGlossary');
    const aiEndpointInput = document.getElementById('aiEndpoint');
    const saveAiEndpoint = document.getElementById('saveAiEndpoint');
    const colorInputs = Array.from(document.querySelectorAll('#themePanel input[type="color"]'));
    const popoverTpl = document.getElementById('popoverTpl');

    // worker for indexing glossary
    const workerCode = `
      self.onmessage = function(ev) {
        const { type, glossary } = ev.data;
        if (type === 'build') {
          const index = {};
          for (const [k, v] of Object.entries(glossary)) {
            const key = k.toLowerCase();
            index[key] = v;
            // naive pluralization variant
            if (k.length > 3 && !k.endsWith('s')) index[(k + 's').toLowerCase()] = v;
          }
          self.postMessage({ type: 'ready', index });
        }
      };
    `;
    const workerBlob = new Blob([workerCode], { type: 'text/javascript' });
    const workerUrl = URL.createObjectURL(workerBlob);
    const glossaryWorker = new Worker(workerUrl);

    let glossaryIndex = null;
    let workerReady = false;

    glossaryWorker.onmessage = (ev) => {
      if (ev.data && ev.data.type === 'ready') {
        glossaryIndex = ev.data.index;
        workerReady = true;
        statusPill.textContent = 'Glossary indexed';
      }
    };

    // Local fallback glossary (small sample). The full-large glossary is loaded lazily.
    const FALLBACK_GLOSSARY = {
      "applicant":{"simple":"person applying","note":"the person using the form"},
      "hereby":{"simple":"now","note":"formal word often used by the document"},
      "pursuant to":{"simple":"according to","note":"refers to a rule or law"},
      "notwithstanding":{"simple":"even though","note":"overrides another clause"},
      "remit":{"simple":"send","note":"send documents, fees, or proof"},
      "void":{"simple":"invalid","note":"not accepted"}
    };

    // We'll maintain LARGE_GLOSSARY as the primary store (initially fallback)
    const LARGE_GLOSSARY = Object.assign({}, FALLBACK_GLOSSARY);

    // attempt to load user-configured external glossary (LZ-String compressed)
    function fetchAndLoadExternalGlossary(url) {
      if (!url) return Promise.reject(new Error('No URL'));
      statusPill.textContent = 'Loading external glossary‚Ä¶';
      return fetch(url).then(r => {
        if (!r.ok) throw new Error('Failed to fetch glossary');
        return r.text();
      }).then(txt => {
        // assume text is LZ compressed via compressToEncodedURIComponent
        let decompressed;
        try {
          decompressed = LZString.decompressFromEncodedURIComponent(txt);
        } catch (e) {
          // maybe it's raw JSON string
          try { decompressed = txt; } catch (err) { decompressed = null; }
        }
        if (!decompressed) throw new Error('Failed to decompress glossary');
        let parsed;
        try { parsed = JSON.parse(decompressed); } catch (e) { parsed = null; }
        if (!parsed) throw new Error('Invalid glossary JSON');
        Object.assign(LARGE_GLOSSARY, parsed);
        buildGlossaryIndex();
        statusPill.textContent = 'External glossary loaded';
        return parsed;
      });
    }

    // Build index via worker
    function buildGlossaryIndex() {
      if (workerReady && glossaryIndex) {
        // rebuild by sending glossary again (worker will post ready again)
      }
      statusPill.textContent = 'Indexing glossary‚Ä¶';
      glossaryWorker.postMessage({ type: 'build', glossary: LARGE_GLOSSARY });
    }

    // Utility safe DOM
    function appendText(el, text) { el.appendChild(document.createTextNode(text)); }
    function clearChildren(el){ while (el.firstChild) el.removeChild(el.firstChild); }
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }
    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Preset vocab maps for target reading levels (example mappings)
    const PRESET_VOCAB = {
      eli5: {
        "applicant":"person applying",
        "pursuant to":"because of",
        "hereby":"now",
        "notwithstanding":"even though",
        "remit":"send",
        "void":"not valid",
        "consents":"says yes",
        "documentation":"papers",
        "failure":"if you don't",
        "assessment":"check",
        "SIN":"Social Insurance Number (SIN)"
      },
      "5": {}, // maps to eli5 at runtime
      "10": { "consents":"agrees", "documentation":"documents", "assessment":"review" },
      teen: { "consents":"agrees", "documentation":"documents", "remit":"submit" },
      adult: { "pursuant to":"under", "notwithstanding":"despite", "remit":"send" },
      legal: {} // minimal replacements
    };

    // base replacement patterns depending on difficulty
    function getBasePatterns(level) {
      const base = [
        { find: /\bpursuant to\b/gi, replace: level === 3 ? 'according to' : 'under' },
        { find: /\bherein\b/gi, replace: 'in this document' },
        { find: /\bhereby\b/gi, replace: 'now' },
        { find: /\bnotwithstanding\b/gi, replace: 'even though' },
        { find: /\bremit\b/gi, replace: 'send' },
        { find: /\bvoid\b/gi, replace: 'invalid' },
        { find: /\bshall\b/gi, replace: 'must' },
        { find: /\bprior to\b/gi, replace: 'before' },
        { find: /\bsubsequent to\b/gi, replace: 'after' }
      ];
      if (level >= 2) base.push({ find: /\bherewith\b/gi, replace: 'with this' });
      if (level === 3) base.push({ find: /\bapplicant\b/gi, replace: 'person applying' });
      return base;
    }

    // patterns application
    function applyPatterns(text, patterns) {
      let out = text;
      const hits = [];
      for (const p of patterns) {
        out = out.replace(p.find, (match) => {
          hits.push(match);
          return typeof p.replace === 'function' ? p.replace(match) : p.replace;
        });
      }
      return { out, hits };
    }

    // preset vocab application
    function applyPresetVocab(text, preset) {
      const key = (preset === '5') ? 'eli5' : preset;
      const mapping = PRESET_VOCAB[key] || {};
      if (!Object.keys(mapping).length) return { text, hits: [] };
      let out = text;
      const hits = [];
      const keys = Object.keys(mapping).sort((a,b)=>b.length-a.length);
      for (const k of keys) {
        const re = new RegExp('\\b' + escapeRegExp(k) + '\\b','gi');
        out = out.replace(re, (m) => { hits.push(m); return mapping[k]; });
      }
      return { text: out, hits };
    }

    // naive sentence simplifier for child presets
    function sentenceSimplify(text, preset) {
      if (preset === 'legal' || preset === 'adult') return text;
      const sentences = text.match(/[^.!?]+[.!?]*/g) || [text];
      const outParts = [];
      sentences.forEach(s => {
        let part = s.trim();
        if (preset === 'eli5' || preset === '5') {
          part = part.replace(/,\s+/g, '. ').replace(/\s+and\s+/g, '. ');
        } else if (preset === '10') {
          part = part.replace(/,\s+/g, '. ');
        }
        if (!/[.!?]$/.test(part)) part = part + '.';
        outParts.push(part);
      });
      return outParts.join(' ');
    }

    // main simplify orchestrator
    function simplifyForPreset(inputText, presetKey, difficultyLevel) {
      let text = inputText || '';
      // base patterns
      const patterns = getBasePatterns(difficultyLevel);
      const base = applyPatterns(text, patterns);
      text = base.out;
      // preset vocab
      const pv = applyPresetVocab(text, presetKey);
      text = pv.text;
      // sentence simplification
      text = sentenceSimplify(text, presetKey === '5' ? 'eli5' : presetKey);
      const hits = base.hits.concat(pv.hits);
      return { simplified: text, hits };
    }

    // highlight nodes creation
    function highlightNodes(text, hits) {
      const uniq = Array.from(new Set(hits.map(h => h.toLowerCase().trim()))).filter(Boolean);
      if (!uniq.length) return [document.createTextNode(text)];
      const fragment = document.createDocumentFragment();
      const escaped = uniq.map(escapeRegExp).join('|');
      const regex = new RegExp('\\b(' + escaped + ')\\b','gi');
      let last = 0, m;
      while ((m = regex.exec(text)) !== null) {
        if (m.index > last) fragment.appendChild(document.createTextNode(text.slice(last, m.index)));
        const mark = document.createElement('mark');
        mark.className = 'repl';
        mark.dataset.term = m[0];
        mark.title = 'Click to explain';
        mark.addEventListener('click', () => explainTerm(m[0]));
        mark.appendChild(document.createTextNode(m[0]));
        fragment.appendChild(mark);
        last = regex.lastIndex;
      }
      if (last < text.length) fragment.appendChild(document.createTextNode(text.slice(last)));
      return Array.from(fragment.childNodes);
    }

    // render result safely
    function renderResult(text, hits) {
      clearChildren(outputEl);
      const nodes = highlightNodes(text, hits);
      const wrap = document.createElement('div');
      wrap.classList.add('fade-in');
      nodes.forEach(n => wrap.appendChild(n));
      outputEl.appendChild(wrap);
      return Array.from(new Set(hits.map(h => h.toLowerCase().trim()).filter(Boolean)));
    }

    // render glossary list for detected terms
    function renderGlossary(terms) {
      clearChildren(glossaryEl);
      if (!terms || terms.length === 0) {
        const li = document.createElement('li');
        const small = document.createElement('small');
        small.className = 'muted';
        appendText(small, 'No special terms detected.');
        li.appendChild(small);
        glossaryEl.appendChild(li);
        return;
      }
      for (const t of terms) {
        const li = document.createElement('li');
        const strong = document.createElement('strong');
        appendText(strong, t);
        li.appendChild(strong);
        const def = (glossaryIndex && glossaryIndex[t]) ? glossaryIndex[t] : (LARGE_GLOSSARY[t] || null);
        const div = document.createElement('div');
        div.style.marginTop = '6px';
        appendText(div, def ? def.simple : '(no local definition)');
        li.appendChild(div);
        if (def && def.note) {
          const note = document.createElement('small');
          note.className = 'muted';
          note.style.display = 'block';
          note.style.marginTop = '6px';
          appendText(note, def.note);
          li.appendChild(note);
        }
        glossaryEl.appendChild(li);
      }
    }

    // popover
    function showPopover(title, body) {
      const existing = document.querySelector('.popover');
      if (existing) existing.remove();
      const tpl = popoverTpl.content.cloneNode(true);
      const pop = tpl.querySelector('.popover');
      pop.querySelector('.title').textContent = title;
      pop.querySelector('.body').textContent = body;
      pop.querySelector('.close').addEventListener('click', () => pop.remove());
      document.body.appendChild(pop);
      pop.querySelector('.close').focus();
    }
    function explainTerm(term) {
      const key = term.toLowerCase();
      const def = (glossaryIndex && glossaryIndex[key]) ? glossaryIndex[key] : (LARGE_GLOSSARY[key] || null);
      if (def) showPopover(term, (def.simple || '') + (def.note ? ('\n\n' + def.note) : ''));
      else showPopover(term, 'No local definition found. Upload or paste a glossary JSON to merge more definitions.');
    }

    // core actions
    function simplifyAll(mode='simple') {
      const raw = inputEl.value || '';
      const preset = presetSelect.value;
      const lvl = parseInt(difficulty.value, 10) || 1;
      const presetKey = (preset === '5') ? 'eli5' : preset;
      const { simplified, hits } = simplifyForPreset(raw, presetKey, lvl);
      const detected = renderResult(simplified, hits);
      renderGlossary(detected);
      modePill.textContent = `Mode: ${mode === 'simple' ? 'Simple' : (mode === 'line' ? 'Line-by-line' : 'Simple')}`;
      termPill.textContent = `Terms: ${detected.length}`;
      statusPill.textContent = 'Simplified';
      return { raw, simplified, detected, hits };
    }

    // line-by-line
    btnLine.addEventListener('click', () => {
      const raw = inputEl.value || '';
      const sentences = raw.match(/[^.!?]+[.!?]*/g) || [raw];
      clearChildren(outputEl);
      let allHits = [];
      const preset = presetSelect.value;
      const presetKey = (preset === '5') ? 'eli5' : preset;
      const lvl = parseInt(difficulty.value,10) || 1;
      sentences.forEach(s => {
        const block = document.createElement('div');
        block.style.marginBottom = '12px';
        const smallO = document.createElement('small'); smallO.className = 'muted'; appendText(smallO,'Original');
        const orig = document.createElement('div'); appendText(orig, s.trim());
        const smallS = document.createElement('small'); smallS.className = 'muted'; smallS.style.marginTop='6px'; appendText(smallS,'Simplified');
        const simpWrap = document.createElement('div'); simpWrap.style.marginTop='6px';
        const { simplified, hits } = simplifyForPreset(s, presetKey, lvl);
        const nodes = highlightNodes(simplified, hits);
        nodes.forEach(n => simpWrap.appendChild(n));
        block.appendChild(smallO); block.appendChild(orig); block.appendChild(smallS); block.appendChild(simpWrap);
        outputEl.appendChild(block);
        allHits = allHits.concat(hits);
      });
      const detected = Array.from(new Set(allHits.map(h => h.toLowerCase().trim())));
      renderGlossary(detected);
      modePill.textContent = 'Mode: Line-by-line';
      termPill.textContent = `Terms: ${detected.length}`;
      statusPill.textContent = 'Line-by-line view';
    });

    btnSimplify.addEventListener('click', () => simplifyAll('simple'));
    btnCopy.addEventListener('click', async () => {
      const r = simplifyAll();
      try { await navigator.clipboard.writeText(r.simplified); alert('Copied simplified text.'); } catch { alert('Could not copy.'); }
    });

    // download txt
    btnTxt.addEventListener('click', () => {
      const r = simplifyAll();
      const blob = new Blob([r.simplified], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'paperbridge-simplified.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // print-to-pdf
    btnPdf.addEventListener('click', () => {
      const r = simplifyAll();
      const w = window.open('', '_blank', 'noopener');
      if (!w) { alert('Unable to open print window.'); return; }
      const doc = w.document;
      doc.write('<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PaperBridge ‚Äî PDF</title>');
      doc.write('<style>body{font-family:Inter,system-ui,Arial;color:#111;margin:28px}pre{white-space:pre-wrap;font-family:inherit;font-size:14px}h1{font-size:18px;margin-bottom:8px}</style>');
      doc.write('</head><body>');
      doc.write('<h1>PaperBridge ‚Äî Simplified</h1>');
      doc.write('<pre>' + escapeHtml(r.simplified) + '</pre>');
      doc.write('</body></html>');
      doc.close();
      setTimeout(()=>w.print(), 300);
    });

    // compressed share via LZ-String
    btnShare.addEventListener('click', async () => {
      const r = simplifyAll();
      try {
        const compressed = LZString.compressToEncodedURIComponent(r.simplified);
        const url = location.origin + location.pathname + '?t=' + compressed;
        await navigator.clipboard.writeText(url);
        alert('Share link copied (compressed).');
      } catch { alert('Could not create share link.'); }
    });

    btnClear.addEventListener('click', () => {
      inputEl.value = '';
      clearChildren(outputEl);
      glossaryEl.innerHTML = '<li><small class="muted">No special terms detected.</small></li>';
      termPill.textContent = 'Terms: 0';
      statusPill.textContent = 'Cleared';
    });

    difficulty.addEventListener('input', () => {
      const val = parseInt(difficulty.value,10);
      diffLabel.textContent = val===1 ? 'Simple' : (val===2 ? 'Medium' : 'Strong');
    });
    difficulty.addEventListener('change', () => simplifyAll());
    presetSelect.addEventListener('change', () => simplifyAll());

    // File upload: handle .txt/.md/.json/.docx/.pdf
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const name = f.name.toLowerCase();
      if (name.endsWith('.docx')) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          const ab = ev.target.result;
          mammoth.extractRawText({arrayBuffer:ab}).then(result => {
            inputEl.value = result.value || '';
            simplifyAll();
          }).catch(()=>{ alert('Could not parse docx.'); });
        };
        reader.readAsArrayBuffer(f);
      } else if (name.endsWith('.pdf')) {
        const reader = new FileReader();
        reader.onload = async function(ev) {
          const ab = ev.target.result;
          try {
            // pdfjs extraction
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            const loadingTask = pdfjsLib.getDocument({data:ab});
            const pdf = await loadingTask.promise;
            let text = '';
            for (let i=1;i<=pdf.numPages;i++){
              const page = await pdf.getPage(i);
              const content = await page.getTextContent();
              const strings = content.items.map(it => it.str);
              text += strings.join(' ') + '\n\n';
            }
            inputEl.value = text;
            simplifyAll();
          } catch (err) {
            console.error(err);
            alert('Could not extract text from PDF. Consider converting to .docx or .txt.');
          }
        };
        reader.readAsArrayBuffer(f);
      } else {
        const reader = new FileReader();
        reader.onload = function(ev) {
          inputEl.value = String(ev.target.result || '');
          simplifyAll();
        };
        reader.readAsText(f);
      }
    });

    // glossary upload merge
    glossaryUpload.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result || ''));
          Object.assign(LARGE_GLOSSARY, parsed);
          buildGlossaryIndex();
          alert('Glossary merged.');
        } catch (err) { alert('Invalid glossary JSON.'); }
      };
      reader.readAsText(f);
    });

    // Drag/drop glossary merge
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      if (!f.name.endsWith('.json')) return alert('Drop a .json glossary file.');
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          Object.assign(LARGE_GLOSSARY, parsed);
          buildGlossaryIndex();
          alert('Glossary file merged.');
        } catch (err) { alert('Invalid JSON file'); }
      };
      reader.readAsText(f);
    });

    // Restore from ?t= compressed share
    (function restoreFromURL(){
      try {
        const params = new URLSearchParams(location.search);
        const t = params.get('t');
        if (!t) return;
        const decompressed = LZString.decompressFromEncodedURIComponent(t);
        if (decompressed) {
          clearChildren(outputEl);
          const wrapper = document.createElement('div');
          appendText(wrapper, decompressed);
          outputEl.appendChild(wrapper);
          statusPill.textContent = 'Shared result';
          // derive hits by running simplifier heuristics to detect potential terms
          const { hits } = simplifyForPreset(decompressed, presetSelect.value === '5' ? 'eli5' : presetSelect.value, parseInt(difficulty.value,10));
          const detected = Array.from(new Set(hits.map(h=>h.toLowerCase().trim())));
          renderGlossary(detected);
          modePill.textContent = 'Mode: Shared';
          termPill.textContent = `Terms: ${detected.length}`;
        }
      } catch(e){}
    })();

    // Theme panel & focus trap
    const DEFAULT_THEME = {
      mode:'light',
      vars:{
        '--bg':'#f7f7fb','--card':'#ffffff','--text':'#0f172a','--accent':'#0f62fe','--border':'#d7d7e6','--pill-bg':'#eef2ff','--pill-border':'#c7d2fe'
      }
    };
    const DARK_THEME = {
      mode:'dark',
      vars:{
        '--bg':'#0f1224','--card':'#111427','--text':'#e3e6ef','--accent':'#4f46e5','--border':'#222745','--pill-bg':'#1f2440','--pill-border':'#2b3158'
      }
    };
    function applyTheme(theme) {
      Object.entries(theme.vars).forEach(([k,v]) => document.documentElement.style.setProperty(k,v));
      document.documentElement.setAttribute('data-theme', theme.mode === 'dark' ? 'dark' : 'light');
      colorInputs.forEach(inp => {
        const key = inp.dataset.var;
        if (key && theme.vars[key]) inp.value = theme.vars[key];
      });
      localStorage.setItem('paperbridge:theme', JSON.stringify(theme));
    }
    function loadTheme() {
      try {
        const raw = localStorage.getItem('paperbridge:theme');
        if (!raw) {
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          applyTheme(prefersDark ? DARK_THEME : DEFAULT_THEME);
          return;
        }
        applyTheme(JSON.parse(raw));
      } catch { applyTheme(DEFAULT_THEME); }
    }
    loadTheme();

    let panelOpen = false; let lastFocused = null;
    const focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    function trapFocus(container) {
      const nodes = Array.from(container.querySelectorAll(focusableSelector)).filter(n => !n.disabled);
      if (!nodes.length) return;
      let i = 0;
      function keyHandler(e) {
        if (e.key === 'Tab') {
          e.preventDefault();
          if (e.shiftKey) i = (i - 1 + nodes.length) % nodes.length;
          else i = (i + 1) % nodes.length;
          nodes[i].focus();
        } else if (e.key === 'Escape') closePanel();
      }
      container.addEventListener('keydown', keyHandler);
      return () => container.removeEventListener('keydown', keyHandler);
    }
    let releaseTrap = null;
    function openPanel() {
      lastFocused = document.activeElement;
      themePanel.classList.remove('hidden'); themePanel.setAttribute('aria-hidden','false'); panelOpen = true;
      const first = themePanel.querySelector('input[type="color"], button, [tabindex]:not([tabindex="-1"])');
      if (first) first.focus();
      releaseTrap = trapFocus(themePanel);
      // populate external glossary & ai endpoint inputs from storage
      externalGlossaryUrlInput.value = localStorage.getItem('paperbridge:externalGlossaryUrl') || '';
      aiEndpointInput.value = localStorage.getItem('paperbridge:aiEndpoint') || '';
    }
    function closePanel() {
      themePanel.classList.add('hidden'); themePanel.setAttribute('aria-hidden','true'); panelOpen = false;
      if (lastFocused && lastFocused.focus) lastFocused.focus();
      if (releaseTrap) { releaseTrap(); releaseTrap = null; }
    }
    gear.addEventListener('click', () => panelOpen ? closePanel() : openPanel());
    document.getElementById('openTheme').addEventListener('click', () => panelOpen ? closePanel() : openPanel());
    themeClose.addEventListener('click', closePanel);

    colorInputs.forEach(inp => {
      inp.addEventListener('input', (e) => {
        const k = e.target.dataset.var; const v = e.target.value;
        if (!k) return;
        document.documentElement.style.setProperty(k, v);
        const stored = JSON.parse(localStorage.getItem('paperbridge:theme') || JSON.stringify(DEFAULT_THEME));
        stored.vars[k] = v;
        localStorage.setItem('paperbridge:theme', JSON.stringify(stored));
      });
    });

    themeReset.addEventListener('click', () => applyTheme(DEFAULT_THEME));
    themeDark.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? DEFAULT_THEME : DARK_THEME));
    themeCopy.addEventListener('click', async () => {
      try { const theme = JSON.parse(localStorage.getItem('paperbridge:theme') || JSON.stringify(DEFAULT_THEME)); await navigator.clipboard.writeText(JSON.stringify(theme, null, 2)); alert('Theme JSON copied.'); } catch { alert('Copy failed.'); }
    });
    themePaste.addEventListener('click', () => {
      const raw = prompt('Paste theme JSON or glossary JSON (term‚Üí{simple,note})');
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (parsed.vars) { applyTheme(parsed); alert('Theme applied.'); }
        else { Object.assign(LARGE_GLOSSARY, parsed); buildGlossaryIndex(); alert('Glossary merged.'); }
      } catch (e) { alert('Invalid JSON.'); }
    });
    themeExport.addEventListener('click', () => {
      const theme = localStorage.getItem('paperbridge:theme') || JSON.stringify(DEFAULT_THEME);
      const blob = new Blob([theme], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'paperbridge-theme.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // External glossary load
    loadExternalGlossary.addEventListener('click', () => {
      const url = externalGlossaryUrlInput.value.trim();
      if (!url) return alert('Enter a URL to a compressed glossary file (LZ-String compressed JSON).');
      fetchAndLoadExternalGlossary(url).then(() => {
        localStorage.setItem('paperbridge:externalGlossaryUrl', url);
      }).catch(err => { console.error(err); alert('Failed to load external glossary: ' + (err && err.message || 'error')); });
    });
    clearExternalGlossary.addEventListener('click', () => {
      externalGlossaryUrlInput.value = '';
      localStorage.removeItem('paperbridge:externalGlossaryUrl');
      alert('Cleared external glossary URL (existing in-memory glossary remains).');
    });

    // AI endpoint saving
    saveAiEndpoint.addEventListener('click', () => {
      const url = aiEndpointInput.value.trim();
      if (!url) { localStorage.removeItem('paperbridge:aiEndpoint'); alert('Cleared AI endpoint.'); return; }
      localStorage.setItem('paperbridge:aiEndpoint', url);
      alert('Saved AI endpoint (client will call this proxy if used).');
    });

    // Start indexing if there's an external glossary URL saved
    (function initExternal() {
      const url = localStorage.getItem('paperbridge:externalGlossaryUrl');
      if (url) {
        externalGlossaryUrlInput.value = url;
        fetchAndLoadExternalGlossary(url).catch(()=>{ /* ignore */ });
      }
      // attempt to build index from current LARGE_GLOSSARY
      setTimeout(buildGlossaryIndex, 200);
    })();

    // AI rewrite flow: prompts user to confirm & uses saved endpoint
    btnAI.addEventListener('click', async () => {
      const endpoint = localStorage.getItem('paperbridge:aiEndpoint') || aiEndpointInput.value.trim();
      if (!endpoint) {
        const ok = confirm('No AI endpoint configured. Open Theme panel to set a proxy endpoint?');
        if (ok) openPanel();
        return;
      }
      const r = simplifyAll();
      const preset = presetSelect.value;
      const lvl = parseInt(difficulty.value,10) || 1;
      statusPill.textContent = 'AI rewriting‚Ä¶';
      try {
        const resp = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: r.raw, preset, difficulty: lvl })
        });
        if (!resp.ok) throw new Error('AI endpoint error ' + resp.status);
        const data = await resp.json();
        if (!data || typeof data.rewritten !== 'string') throw new Error('Invalid response (expect { rewritten: string })');
        // show AI result in output (safe)
        clearChildren(outputEl);
        const wrapper = document.createElement('div');
        appendText(wrapper, data.rewritten);
        outputEl.appendChild(wrapper);
        statusPill.textContent = 'AI rewrite complete';
        // detect glossary hits from rewritten text
        const { hits } = simplifyForPreset(data.rewritten, (preset === '5') ? 'eli5' : preset, lvl);
        const detected = Array.from(new Set(hits.map(h=>h.toLowerCase().trim())));
        renderGlossary(detected);
        modePill.textContent = 'Mode: AI';
        termPill.textContent = `Terms: ${detected.length}`;
      } catch (err) {
        console.error(err);
        alert('AI rewrite failed: ' + (err && err.message));
        statusPill.textContent = 'AI failed';
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'o' && e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey) { e.preventDefault(); panelOpen ? closePanel() : openPanel(); }
      if (e.key === 'Escape') { if (panelOpen) closePanel(); const p = document.querySelector('.popover'); if (p) p.remove(); }
    });

    // expose some utilities for debugging
    window._paperbridge = {
      simplifyAll,
      LARGE_GLOSSARY,
      buildGlossaryIndex,
      fetchAndLoadExternalGlossary
    };

    // Initial simplify of sample text
    simplifyAll();
  })();

  // Configure PDF.js worker path (CDN)
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  }
  </script>
</body>
</html>
